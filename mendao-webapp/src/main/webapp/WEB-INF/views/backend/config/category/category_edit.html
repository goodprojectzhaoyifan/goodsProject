<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
	<title>门道教育网－配置管理</title>
	<head th:include="layout/head :: backend"></head>
	<head th:include="layout/head :: validator"></head>
	<link th:href="@{/bootstrap-tree/bootstrap-treeview.min.css}" rel="stylesheet"/>
	<script th:src="@{/bootstrap-tree/bootstrap-treeview.min.js}" type="text/javascript"></script>
	<style>
		.ul_label, .ul_label_none{width:15px;}
		.ul_label:hover{cursor:pointer; color: red;}
		.subul{margin-left: 20px; display:none;}
	</style>
</head>
<body class="index">
<div th:include="layout/common/header::nav-header"></div>
<div class="container" id="content-container">
	<div class="row">
		<div th:include="layout/backend_nav::nav-backend"></div>
		
		<div class="col-md-9">
			<div class="panel panel-default panel-col">
				<div class="panel-heading">类目分类</div>
				<div class="panel-body" id="divForm">
					<form id="defaultForm" method="post" class="form-horizontal" 
                      data-bv-message="This value is not valid"
                      data-bv-feedbackicons-valid="glyphicon glyphicon-ok"
                      data-bv-feedbackicons-invalid="glyphicon glyphicon-remove"
                      data-bv-feedbackicons-validating="glyphicon glyphicon-refresh">
                      <input type="hidden" name="id" th:value="${category.id}" />
                	<fieldset>
	                    <div class="form-group">
	                        <label class="col-lg-2 control-label">类目编码</label>
	                        <div class="col-lg-3 col-sm-5">
	                            <select name="code">
	                            	<option th:each="item,iterStat: ${codeMap}" th:value="${item.key}" th:text="${item.value}"/>
	                            </select>
	                        </div>
	                    </div>
	                    <div class="form-group">
	                        <label class="col-lg-2 control-label">类目名称</label>
	                        <div class="col-lg-3 col-sm-5">
	                            <input type="text" class="form-control" name="display" th:value="${category.display}" placeholder="类目名称" required="required" />
	                        </div>
	                    </div>
	                    <div class="form-group">
	                        <label class="col-lg-2 control-label">父类目名称</label>
	                        <div id="parents" class="col-lg-3 col-sm-5" style="">
	                        	<input type="hidden" id="parent_id" name="parent.id" th:if="${category.parent}" th:value="${category.parent.id}"/>
	                        	<input type="hidden" id="parent_id" name="parent.id" th:if="${#strings.isEmpty(category.parent)}"/>
	                        	<input type="text" id="parent_name" name="parent.display" value="ROOT" readonly="readonly"/>
	                        </div>
	                        
	                    </div>
	                    <div class="form-group">
	                        <label class="col-lg-2 control-label">标签类型</label>
	                        <div class="col-lg-8 col-sm-5">
	                        	<input type="checkbox" name="type"  value="SCHOOL_STICKER" 
	                        		th:checked="${#strings.contains(#strings.defaultString(category.type, ''), 'SCHOOL_STICKER')}"/> 机构标签
	                        	<input type="checkbox" name="type" value="TOPIC_STICKER" 
	                        		th:checked="${#strings.contains(#strings.defaultString(category.type, ''), 'TOPIC_STICKER')}"/> 话题标签
	                        	<input type="checkbox" name="type" value="ACTIVITY_STICKER" 
	                        		th:checked="${#strings.contains(#strings.defaultString(category.type, ''), 'ACTIVITY_STICKER')}"/> 活动标签
	                        	<input type="checkbox" name="type" value="FOLLOW_STICKER" 
	                        		th:checked="${#strings.contains(#strings.defaultString(category.type, ''), 'FOLLOW_STICKER')}"/> 关注标签
	                        </div>
	                    </div>
	                    <div class="form-group">
	                        <label class="col-lg-2 control-label">排序</label>
	                        <div class="col-lg-3 col-sm-5" >
	                        	<div class="input-group">
								  <span class="input-group-addon" id="basic-addon1">
								  <span th:if="${category.parent}" th:text="${category.parent.sortSeq} + '.'">*</span></span>
								  <input th:if="${category.parent}" type="text" class="form-control" placeholder="" th:value="${#strings.substringAfter(category.sortSeq, category.parent.sortSeq+'.')}" id="sortSeq" name="sortSeq" required="required" pattern="^[0-9]{1,3}([.]{1}[0-9]{1,3}){0,10}$" aria-describedby="basic-addon1" />
								  <input th:if="${#strings.isEmpty(category.parent)}" type="text" class="form-control" placeholder="" th:value="${category.sortSeq}" id="sortSeq" name="sortSeq" required="required" pattern="^[0-9]{1,3}([.]{1}[0-9]{1,3}){0,10}$" aria-describedby="basic-addon1" />
								</div>
	                        </div>
	                    </div>
	                    </fieldset>
	                    <div class="form-group">
	                        <div class="col-lg-5 col-lg-offset-2">
	                            <button type="submit" class="btn btn-primary">提交</button>
	                        </div>
	                    </div>
	                </form>
				</div>
			
				<div class="panel-body" id="divParent" style="display:none;">
					<div id="treeview-selectable"></div>
					<div class="form-group">
                        <div class="col-lg-5 col-lg-offset-2">
                            <button type="button" id="btnConfirm" class="btn btn-primary">确定</button>
                        </div>
                    </div>
				</div>
			</div>
		</div>
	</div>
</div>
<script th:inline="javascript">
/*<![CDATA[*/
	$(function(){
		$('#parents').click(function(){
			$('#divParent').toggle();
			$('#divForm').toggle();
		});
		$('#btnConfirm').click(function(){
			$('#divParent').toggle();
			$('#divForm').toggle();
		});
		var url = /*[[@{/backend/config/categoryTree}]]*/;
		var myTree;
		$.getJSON(url, null, function(data){
			myTree = $('#treeview-selectable').treeview({
				showTags: true,
	            data: data,
	            levels: 0,
	            onNodeSelected: function(event, node) {
	            	var custAttr = $.parseJSON(node.custAttr);
	    			$('#basic-addon1').text(custAttr.sortSeq + ".");
	    			$('#parent_id').val(custAttr.realId);
	            	$('#parent_name').val(node.text);
	            },
	            onNodeUnselected: function (event, node) {
	            	$('#basic-addon1').text("");
	            	$('#parent_id').val('');
	            	$('#parent_name').val('ROOT');
	            }
	    	});
			var parent = $('#parent_name').val();
			if(!!parent){
				var search = function(e) {
			        var pattern = parent;
			        var options = {
			          ignoreCase: true,
			          exactMatch: true,
			          revealResults: true
			        };
			        var results = myTree.treeview('search', [ pattern, options ]);
			        $.each(results, function (index, result) {
		            	result.state.selected = true;
		            	myTree.treeview('selectNode', [ result.nodeId, { silent: true } ]);
		          	});
		        };
		        search();
			}
			
		});
	});
/*]]>*/
</script>
</body>
</html>
